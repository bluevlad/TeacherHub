name: Deploy to Production

on:
  push:
    branches:
      - prod

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        run: |
          cd ${{ env.DEPLOY_PATH }}
          git fetch origin prod
          git reset --hard origin/prod

      - name: Create .env file
        run: |
          cd ${{ env.DEPLOY_PATH }}
          cat > .env << EOF
          # Auto-generated by GitHub Actions
          # $(date)

          # Database
          DB_HOST=postgresql
          DB_PORT=5432
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          DB_NAME=teacherhub

          # API URL
          API_URL=http://localhost:9010

          # Ollama
          OLLAMA_HOST=http://host.docker.internal:11434
          EOF

      - name: Build and Deploy
        run: |
          cd ${{ env.DEPLOY_PATH }}

          echo "Stopping existing containers..."
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          docker compose down --remove-orphans || true
          docker rm -f teacherhub-backend teacherhub-frontend teacherhub-ai 2>/dev/null || true

          echo "Building containers..."
          docker compose -f docker-compose.prod.yml build

          echo "Starting containers..."
          docker compose -f docker-compose.prod.yml up -d

      - name: Health Check
        run: |
          cd ${{ env.DEPLOY_PATH }}
          sleep 30
          echo "Container Status:"
          docker compose -f docker-compose.prod.yml ps
          echo "Deployment completed!"
