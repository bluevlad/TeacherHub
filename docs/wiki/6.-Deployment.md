# 6. 배포 (Deployment)

## 6.1 배포 환경

### 환경 구성

| 환경 | 위치 | Docker | 포트 |
|------|------|--------|------|
| 개발 | Windows | Docker Desktop | 3000, 8081, 5432 |
| 운영 | MacBook | OrbStack | 4010, 9010 |

### 네트워크 정보

| 항목 | Windows | MacBook |
|------|---------|---------|
| IP | 172.30.1.78 | 172.30.1.72 |
| Frontend | :3000 | :4010 |
| Backend | :8081 | :9010 |

---

## 6.2 CI/CD 파이프라인

### GitHub Actions

```
prod 브랜치 Push
       │
       ▼
┌──────────────────────┐
│   GitHub Actions     │
│                      │
│  1. Checkout         │
│  2. Build Backend    │
│  3. Build Frontend   │
│  4. Deploy to Server │
└──────────────────────┘
       │
       ▼
   MacBook 배포
```

### 워크플로우 파일

`.github/workflows/deploy.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [prod]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend
        run: |
          cd backend
          ./gradlew build -x test

      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Deploy
        run: |
          # SSH 배포 또는 Docker 이미지 푸시
```

---

## 6.3 수동 배포 (Windows → MacBook)

### Step 1: Docker 이미지 빌드

```bash
cd C:\GIT\TeacherHub

# Backend
docker build -t research-hub/teacherhub-api:latest ./backend

# Frontend
docker build -t research-hub/teacherhub-front:latest ./frontend

# AI Crawler
docker build -t research-hub/teacherhub-ai:latest ./ai-crawler
```

### Step 2: 이미지 내보내기

```bash
mkdir -p deploy/exports

docker save research-hub/teacherhub-api:latest -o deploy/exports/teacherhub-api_latest.tar
docker save research-hub/teacherhub-front:latest -o deploy/exports/teacherhub-front_latest.tar
docker save research-hub/teacherhub-ai:latest -o deploy/exports/teacherhub-ai_latest.tar
```

### Step 3: DB 백업

```bash
mkdir -p deploy/backups

docker exec teacherhub-db pg_dump -U teacherhub -d teacherhub \
    --no-owner --no-acl > deploy/backups/teacherhub_$(date +%Y%m%d).sql

gzip deploy/backups/teacherhub_*.sql
```

### Step 4: 파일 전송

```bash
scp deploy/exports/*_latest.tar user@172.30.1.72:~/GIT/TeacherHub/deploy/exports/
scp deploy/backups/*.sql.gz user@172.30.1.72:~/GIT/TeacherHub/deploy/backups/
```

### Step 5: MacBook에서 배포

```bash
cd ~/GIT/TeacherHub

# 이미지 로드
docker load -i deploy/exports/teacherhub-api_latest.tar
docker load -i deploy/exports/teacherhub-front_latest.tar
docker load -i deploy/exports/teacherhub-ai_latest.tar

# 기존 컨테이너 중지
docker compose -f docker-compose.prod.yml down

# 서비스 시작
docker compose -f docker-compose.prod.yml up -d

# DB 복원 (필요시)
gunzip -k deploy/backups/teacherhub_*.sql.gz
docker cp deploy/backups/teacherhub_*.sql teacherhub-db-prod:/tmp/
docker exec teacherhub-db-prod psql -U teacherhub -d teacherhub -f /tmp/teacherhub_*.sql
```

---

## 6.4 배포 스크립트

### build-and-export.sh (Windows)

```bash
#!/bin/bash
# 전체 빌드 및 내보내기
./deploy/build-and-export.sh --all

# Backend만
./deploy/build-and-export.sh --backend

# Frontend만
./deploy/build-and-export.sh --frontend
```

### import-and-run.sh (MacBook)

```bash
#!/bin/bash
# 전체 배포
./deploy/import-and-run.sh full-deploy

# 이미지만 가져오기
./deploy/import-and-run.sh import

# 서비스 시작
./deploy/import-and-run.sh start

# 서비스 중지
./deploy/import-and-run.sh stop

# 로그 확인
./deploy/import-and-run.sh logs
```

### backup-db.sh

```bash
#!/bin/bash
# 개발 환경 백업
./deploy/backup-db.sh --dev

# 운영 환경 백업
./deploy/backup-db.sh --prod
```

### restore-db.sh

```bash
#!/bin/bash
# 최근 백업으로 복원
./deploy/restore-db.sh --latest

# 특정 파일로 복원
./deploy/restore-db.sh --from=~/transfers teacherhub_backup.sql.gz
```

---

## 6.5 docker-compose 설정

### 개발 환경 (docker-compose.yml)

```yaml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "8081:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/teacherhub
    depends_on:
      - db

  db:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=teacherhub
      - POSTGRES_USER=teacherhub
      - POSTGRES_PASSWORD=teacherhub
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 운영 환경 (docker-compose.prod.yml)

```yaml
version: '3.8'

services:
  frontend:
    image: research-hub/teacherhub-front:latest
    container_name: teacherhub-frontend-prod
    ports:
      - "4010:3000"
    depends_on:
      - backend

  backend:
    image: research-hub/teacherhub-api:latest
    container_name: teacherhub-backend-prod
    ports:
      - "9010:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/teacherhub
    depends_on:
      - db

  db:
    image: postgres:15
    container_name: teacherhub-db-prod
    environment:
      - POSTGRES_DB=teacherhub
      - POSTGRES_USER=teacherhub
      - POSTGRES_PASSWORD=teacherhub
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

---

## 6.6 모니터링

### 서비스 상태 확인

```bash
# 컨테이너 상태
docker ps --filter "name=teacherhub"

# Health Check
curl http://localhost:9010/actuator/health

# 로그 확인
docker logs -f teacherhub-backend-prod
```

### 리소스 모니터링

```bash
# 컨테이너 리소스 사용량
docker stats teacherhub-backend-prod teacherhub-frontend-prod teacherhub-db-prod

# 디스크 사용량
docker system df
```

---

## 6.7 롤백

### 이전 버전으로 롤백

```bash
# Git에서 이전 버전 체크아웃
git checkout <previous-commit>

# 이미지 재빌드 및 배포
docker build -t research-hub/teacherhub-api:latest ./backend
docker compose -f docker-compose.prod.yml up -d backend
```

### DB 롤백

```bash
# 이전 백업으로 복원
./deploy/restore-db.sh --from=~/backups teacherhub_20260203.sql.gz
```

---

## 6.8 문제 해결

### 포트 충돌

```bash
# 사용 중인 포트 확인
lsof -i :4010
lsof -i :9010

# 프로세스 종료
kill -9 <PID>
```

### 컨테이너 재시작 실패

```bash
# 로그 확인
docker logs teacherhub-backend-prod

# 컨테이너 삭제 후 재생성
docker rm -f teacherhub-backend-prod
docker compose -f docker-compose.prod.yml up -d backend
```

### DB 연결 실패

```bash
# DB 컨테이너 상태 확인
docker logs teacherhub-db-prod

# DB 연결 테스트
docker exec teacherhub-db-prod psql -U teacherhub -d teacherhub -c "SELECT 1"
```

---

## 6.9 접속 URL

### 개발 환경 (Windows)

| 서비스 | URL |
|--------|-----|
| Frontend | http://localhost:3000 |
| Backend API | http://localhost:8081 |
| Health Check | http://localhost:8081/actuator/health |

### 운영 환경 (MacBook)

| 서비스 | URL |
|--------|-----|
| Frontend | http://localhost:4010 |
| Backend API | http://localhost:9010 |
| Health Check | http://localhost:9010/actuator/health |

---

[← 개발 가이드](./5.-Development-Guide) | [Home →](./Home)
